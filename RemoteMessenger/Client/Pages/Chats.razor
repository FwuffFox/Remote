@page "/chats"
@using RemoteMessenger.Shared.Models
@using RemoteMessenger.Client.Services
@attribute [Authorize]
@inject HttpClient HttpClient
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Chats</PageTitle>

@foreach (var chat in PrivateChats)
{
    var othername = chat.FirstUser.Username == _myUsername ? chat.SecondUser.Username : chat.FirstUser.Username;
    <Contact ImageSrc="Icon.png" Name="@othername"></Contact>
}

@code {

    public List<PrivateChat> PrivateChats = new();
    private string _myUsername;
    
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateTask;
        var messengerAuthState = (MessengerAuthStateProvider)AuthenticationStateProvider;
        _myUsername = messengerAuthState.GetUniqueName(authState);
        var result = await HttpClient.GetAsync($"/api/private_chats/getMyChats");
        if (!result.IsSuccessStatusCode)
        {
            NavigationManager.NavigateTo("Error");
        }
        PrivateChats = (await result.Content.ReadFromJsonAsync<List<PrivateChat>>())!;
        await base.OnInitializedAsync();
        StateHasChanged();
    }
}